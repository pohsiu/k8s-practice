name: Create PR environment and add to nginx proxy

# ç•¶ PR è¢«å‰µå»ºæˆ–æ›´æ–°æ™‚è§¸ç™¼
on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  add-to-nginx-proxy:
    runs-on: ubuntu-latest
    
    # ğŸ”’ é—œéµï¼šä½¿ç”¨ concurrency æ§åˆ¶é¿å…ä¸¦ç™¼å•é¡Œ
    # æ‰€æœ‰ PR çš„é…ç½®æ›´æ–°æœƒæ’éšŠåŸ·è¡Œï¼Œä¸æœƒåŒæ™‚é€²è¡Œ
    concurrency:
      group: nginx-proxy-config-update
      cancel-in-progress: false  # ä¸å–æ¶ˆï¼Œè€Œæ˜¯æ’éšŠç­‰å¾…
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'
          
      - name: Check if backend service exists
        id: check-service
        run: |
          PR_BRANCH="pr-${{ github.head_ref }}"
          if kubectl get service express-app-$PR_BRANCH &>/dev/null; then
            echo "service_exists=true" >> $GITHUB_OUTPUT
          else
            echo "service_exists=false" >> $GITHUB_OUTPUT
          fi
          
      - name: Deploy backend service (if needed)
        if: steps.check-service.outputs.service_exists == 'false'
        run: |
          PR_BRANCH="pr-${{ github.head_ref }}"
          # éƒ¨ç½²å¾Œç«¯æœå‹™
          ./scripts/deploy-to-minikube.sh $PR_BRANCH
          
      - name: Add PR to Nginx Proxy
        run: |
          PR_BRANCH="pr-${{ github.head_ref }}"
          ./scripts/add-pr-to-nginx-proxy.sh $PR_BRANCH
          
      - name: Commit and push changes (GitOps)
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # æª¢æŸ¥æ˜¯å¦æœ‰è®Šæ›´
          if [[ -n $(git status -s) ]]; then
            git add k8s/nginx-proxy/
            git commit -m "chore: add PR ${{ github.event.pull_request.number }} to nginx proxy"
            
            # ä½¿ç”¨é‡è©¦æ©Ÿåˆ¶è™•ç†å¯èƒ½çš„è¡çª
            MAX_RETRIES=3
            RETRY_COUNT=0
            
            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              if git push; then
                echo "âœ… Push successful"
                break
              else
                RETRY_COUNT=$((RETRY_COUNT + 1))
                echo "âš ï¸  Push failed, retry $RETRY_COUNT/$MAX_RETRIES"
                
                if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                  git pull --rebase origin ${{ github.ref_name }}
                  sleep 5
                fi
              fi
            done
            
            if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
              echo "âŒ Failed to push after $MAX_RETRIES retries"
              exit 1
            fi
          else
            echo "â„¹ï¸  No changes to commit"
          fi
          
      - name: Verify deployment
        run: |
          PR_BRANCH="pr-${{ github.head_ref }}"
          
          echo "ğŸ” Verifying nginx proxy configuration..."
          
          # æª¢æŸ¥ ConfigMap
          kubectl get configmap nginx-proxy-$PR_BRANCH-config
          
          # æª¢æŸ¥é…ç½®æ˜¯å¦è¼‰å…¥åˆ° Pod
          POD_NAME=$(kubectl get pod -l app=nginx-proxy -o name)
          kubectl exec -it $POD_NAME -- ls /etc/nginx/conf.d/upstreams/$PR_BRANCH.conf
          kubectl exec -it $POD_NAME -- ls /etc/nginx/conf.d/routes/$PR_BRANCH.conf
          
      - name: Comment on PR
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `âœ… This PR has been added to nginx proxy!
              
              **Test your deployment:**
              \`\`\`bash
              curl -H "x-multi-env: pr-${{ github.event.pull_request.number }}" https://your-domain.com/
              \`\`\`
              
              **Deployed services:**
              - Backend: \`express-app-pr-${{ github.event.pull_request.number }}\`
              - Nginx route: \`pr-${{ github.event.pull_request.number }}\`
              `
            })